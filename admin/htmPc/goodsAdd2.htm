<style type="text/css">
    #goodsAdd2{
        position: absolute;
        z-index: 100;
        width: 1200px;
        overflow: hidden;
    }
    .win_column{
        margin-top: -20px;
        border: solid 1px #50D1DE;
        height: 600px;
        overflow: auto;
    }
    .win_column_head{
        background-color: #80E5F0;
        text-align: center;
        overflow: hidden;
        height: 30px;
        line-height: 30px;
        font-weight: bold;
        font-size: 25px;
    }
    .goods_price{
        float: left;
        width: 410px;
    }
    .goods_all{
        float: right;
        width: 780px;
    }
    .goods_price_li{
        width: 100%;
        overflow: hidden;
    }
    .goods_price_head{
        width: 80px;
        text-align: right;
        float: left;
        color: #07A1B1;
        font-size: 15px;
        display: block;
        height: 50px;
        line-height: 50px;
    }
    .goods_price_con{
        border: 1px solid #50D1DE;
        margin: 5px 0 5px 5px;
        padding: 3px 0 0 3px;
        width: 300px;
        float: left;
    }
    .goods_price_con_li{
        width: 70px;
        height: 30px;
        line-height: 30px;
        border: 1px solid #50D1DE;
        margin: 0 3px 3px 0;
        float: left;
        text-align: center;
    }
    .goods_price_con_li:hover{
        cursor: pointer;
        background-color: #50D1DE;
    }
    .goods_price_con_li_click{
        background-color: #50D1DE;
        color:red;
    }

    .goods_price_con_info{
        display: none;
        width: 380px;
        overflow: hidden;
        margin: 5px auto;
        border: 1px solid #50D1DE;
        padding: 2px 0 0 2px;
    }
    .goods_price_con_info >div.goods_price_con_list{
        width: 236px;
        border: hidden;
        height:auto;
        margin: 0;
        float: left;
    }
    .goods_price_con_prop{
        float: left;
        width: 43px;
        border: 1px solid #50D1DE;
        margin: 0 2px 2px 0;
        overflow: hidden;
        border-bottom-style: hidden;
        background-color: #ffffff;
    }
    .goods_td{
        width: 100%;
        height: 16px;
        text-align: center;
        line-height: 16px;
        border-bottom: 1px solid #50D1DE;
    }
    .goods_price_con_prop_select{
        border-bottom: 1px solid red;
    }
    .goods_price_con_info_select{
        background-color: #50D1DE;
    }
    .goods_price_con_prop_name{

    }
    .goods_price_con_sum{
        width: 40px;
        float: right;
    }
    .numbers{
        border-style: hidden;
        outline:none;
        width: 100%;
    }
    .goods_price_con_price{
        width: 57px;
        float: right;
    }
    .goods_price_con_img{
        height: 33px;
        width: 33px;
        float: right;
        border: 1px solid #50D1DE;
    }
    #goods_price_default{
        display: block;
    }
    #allEdit{
        width: 770px;
        height: 600px;
    }
    #goods_price_default>.goods_price_con_list{
        line-height: 35px;
        text-align: center;
        color: #333333;
        font-size: 18px;
        background-color: #eeeeee ;
    }
    .goods_price_con_util{
        float: right;
    }
    #select_img{
        position: absolute;
        z-index: 2000;
        width: 150px;
        height: 110px;
        border: 1px solid #50D1DE;
        background-color: #E0F8FB;
        display: none;
    }
    #select_img >div{
        width: 100px;
        font-size: 20px;
        margin: 10px auto;
    }
    #upload_img{
    }
    #space_img{
        width: 100px;
        font-size: 20px;
    }
    #goods_price_con_info_parents{
        display: none;
    }
</style>
<form action="./server/goodsAdd2Ser.php" method="post" id="goodsAdd2Form">
    <div id='goodsAdd2' class='win show_win'>
        <input type="hidden" name="g_id" id="g_id" value="<{$g_id}>" />
        <h1 class="win_head">添加商品详细资料 <div class="show_win_close">×</div></h1>
        <div class="win_column goods_price">
            <div class ="win_column_head">商品详细价格</div>
            <{foreach $gp as $value}>
            <div class='goods_price_li' gtp_id ="<{$value['gtp_id']}>">
                <label class='goods_price_head'><{$value['gtp_name']}></label>
                <div class='goods_price_con'>
                    <{foreach $value['gp_value'] as $v}>
                    <div class='goods_price_con_li' gp_id="<{$v['gp_id']}> "><{$v['gp_name']}></div>
                    <{/foreach}>
                </div>
            </div>
            <{/foreach}>
            <div class="goods_price_con_info" id="goods_price_default">
                <div class="goods_price_con_list">
                    默认价格
                </div>
                <div class="goods_price_con_img goods_price_con_prop">
                    <img class="preview_img" src="<{$g_img}>?imageView2/5/w/75/h/75" />
                </div>
                <div class="goods_price_con_price goods_price_con_prop">
                    <div class="goods_td">价格</div>
                    <div class="goods_td"><{$g_price}></div>
                </div>
            </div>

            <!--模板-->
            <div id="goods_price_con_info_parents">
                <div class="goods_price_con_list">
                </div>
                <div class="goods_price_con_util goods_price_con_prop">
                    <div class="goods_td i_submit" url="goodsPriceAddSer.php">提交</div>
                    <div class="goods_td i_cancel">取消</div>
                </div>
                <div class="goods_price_con_img goods_price_con_prop select_img" >
                    <img img_url="" class="preview_img goods_price_imgs" />
                </div>
                <div class="goods_price_con_price goods_price_con_prop">
                    <div class="goods_td">价格</div>
                    <div class="goods_td goods_price_input"><input class="numbers" min="0" type="number" name="price" value="<{$g_price}>" ></div>
                </div>
                <div class="goods_price_con_sum goods_price_con_prop">
                    <div class="goods_td">数量</div>
                    <div class="goods_td goods_sum_input"><input class="numbers" min="0" type="number" name="sum" value="0"></div>
                </div>

            </div>
        </div>
        <div class="win_column goods_all">
            <div class ="win_column_head">商品详细介绍</div>
            <div id="allEdit"></div>
        </div>
    </div>
</form>
<script>
    $(function(){
        var editor = new wangEditor('allEdit');
        editor.create();
    });
    $(function (){
        var cancel = function(self){
            self.find('.i_cancel').addClass('i_delete').removeClass('i_cancel').html('删除');
            self.find('.i_submit').addClass('i_update').removeClass('i_submit').html('修改').attr('url','goodsPriceUpdateSer.php');
            self.find('.goods_price_input').html(self.find('.goods_price_input >input').val());
            self.find('.goods_sum_input').html(self.find('.goods_sum_input >input').val());
            self.find('.goods_price_con_img').removeClass('select_img');
            self.removeClass('goods_price_con_info_select');
        }
        //取消
        $('.goods_price').on('click','.i_cancel',function(){
            if($(this).parents('#goods_price_con_info_add').length ==1){
                $(this).parents('.goods_price_con_info').hide();
                $('.goods_price_con_li').removeClass('goods_price_con_li_click');
            }else{
                cancel($(this).parents('.goods_price_con_info'));
            }

        });
        //修改
        $('.goods_price').on('click','.i_update',function(){
            if($('#goods_price_con_info_add').length >0){
                if(typeof ($('#goods_price_con_info_add').attr('gpi_id')) == 'undefined'){
                    $('#goods_price_con_info_add').remove();
                }else{
                    $('#goods_price_con_info_add').find('i_submit').trigger('click');
                    $('#goods_price_con_info_add').attr('id','gpi'+$('#goods_price_con_info_add').attr('gpi_id'));
                }
            }
            var sum = $('#goods_price_con_info_parents .goods_sum_input>input').clone();
            var price = $('#goods_price_con_info_parents .goods_price_input>input').clone();
            var self = $(this).parents('.goods_price_con_info');

            self.attr('id','goods_price_con_info_add');
            self.addClass('goods_price_con_info_select');
            $('.goods_price_con_li').removeClass('goods_price_con_li_click');
            self.find('.goods_price_con_prop').each(function(){
                $('.goods_price_con_li[gp_id="'+$(this).attr('gp_id')+'"]').addClass('goods_price_con_li_click');
            });
            sum.val(self.find('.goods_sum_input').html());
            self.find('.goods_sum_input').html(sum);
            price.val(self.find('.goods_price_input').html());
            self.find('.goods_price_input').html(price);
            self.find('.goods_price_con_img').addClass('select_img');
            $(this).addClass("i_submit").removeClass('i_update').html('提交');
            self.find('.i_delete').addClass('i_cancel').removeClass('i_delete').html('取消');
        });
        //删除
        $('.goods_price').on('click','.i_delete',function(){
            var self = $(this).parents('.goods_price_con_info');
            $.post('./server/goodsPriceDeleteSer.php',{'gpi_id':$(this).parents('.goods_price_con_info').attr('gpi_id')},function(data){
                toast(data.status,data.megs);
                if(data.status){
                    self.remove();
                }
            },'json');

            $('.goods_price_con_li').removeClass('goods_price_con_li_click');
        });
        //提交
        $('.goods_price').on('click','.i_submit',function(){
            var data={},self = $(this).parents('.goods_price_con_info');
            if(typeof (self.attr('gpi_id')) !='undefined'){
                data.gpi_id = self.attr('gpi_id');
            }
            data.g_id = $("input[name='g_id']").val();
            data.gpi_img =self.find('img[img_url]').attr('img_url');
            data.gpi_sum = self.find('input[name="sum"]').val();
            data.gpi_price = self.find('input[name="price"]').val();
            data.gp_ids = self.find('.goods_price_con_prop').map(function(){return $(this).attr('gp_id');}).get();

            $.post("./server/"+$(this).attr('url'),data,function(d){
                toast(d.status,d.megs);
                self.attr('id','gpi'+d.gpi_id);
                self.attr('gpi_id',d.gpi_id);
                $('.goods_price_con_li').removeClass('goods_price_con_li_click');
                cancel(self);
            },'json');
        });
        var listWidth = function (list) {
            var wid = 0;
            var bor = 2;
            list.siblings().each(function(){wid +=$(this).width(); bor +=4;});
            var lw = list.parent().width()-wid-bor;
            list.css('width',lw);

        }

        //选择价格属性
        $('.goods_price_con_li').click(function(){
            $('.goods_price_con_info').removeClass('goods_price_con_info_select');
            if(!$(this).hasClass('goods_price_con_li_click')){ //判断是取消还是选定
                $(this).addClass('goods_price_con_li_click');
                $(this).siblings().removeClass('goods_price_con_li_click');
                var gtp_id = $(this).parents('goods_price_li').attr('gtp_id');
                $(".goods_price_con_info  >.goods_price_con_list >.goods_price_con_prop[gtp_id='"+gtp_id+"'] >.goods_price_con_prop_value").removeClass('goods_price_con_prop_select');
                $(".goods_price_con_info  >.goods_price_con_list >.goods_price_con_prop[gp_id='"+$(this).attr('gp_id')+"'] >.goods_price_con_prop_value").addClass('goods_price_con_prop_select');
                 }else{
                //取消选定的属性
                $(this).removeClass('goods_price_con_li_click');
                $(".goods_price_con_info  >.goods_price_con_list >.goods_price_con_prop[gp_id='"+$(this).attr('gp_id')+"'] >.goods_price_con_prop_value").removeClass('goods_price_con_prop_select');
                //goods_price_con_prop_value
//                $("#goods_price_con_info_add  >.goods_price_con_list >.goods_price_con_prop[gp_id='"+$(this).attr('gp_id')+"']").remove();
//                if($("#goods_price_con_info_add  >.goods_price_con_list >.goods_price_con_prop").length == 0){
//                    $("#goods_price_con_info_add").remove();
//                }
            }
            //获取已选定的价格属性
            var gp_ids  = $('.goods_price_con_li_click').map(function(){return $(this).attr('gp_id');}).get();
            //判断价格方案是否已存在
            var gp_create = true;
            $('.goods_price_con_info:visible').each(function(){
                var gps =  $(this).find('.goods_price_con_prop').map(function(){return $(this).attr('gp_id'); }).get();
                if(gps.sort().join("") == gp_ids.sort().join("")){
                    $("#goods_price_con_info_add").hide();
                    $(this).addClass('goods_price_con_info_select');
                    gp_create = false;
                }
            });
            if(gp_create){

                var a = $("#goods_price_con_info_add");
                a.addClass('goods_price_con_info_select');
                //不存在的价格方案就创建
                if(a.length ==0){
                    a = $('#goods_price_con_info_parents').clone();
                    a.attr('id','goods_price_con_info_add');
                    a.addClass('goods_price_con_info');
                    a.appendTo($('.goods_price'));
                }
                a.find('.goods_price_con_list >div').remove();
                for(var gp_id in gp_ids){
                    var gp_li = $(".goods_price_con_li[gp_id='"+gp_ids[gp_id]+"']");
                    var gp_name = gp_li.html();
                    var gtp_id = gp_li.parents('.goods_price_li').attr('gtp_id');
                    var gtp_name = gp_li.parent().siblings('.goods_price_head').html();
                    a.children('.goods_price_con_list').append(" <div class='goods_price_con_prop' gtp_id='"+gtp_id+"' gp_id='"+gp_ids[gp_id]+"'><div class='goods_td goods_price_con_prop_name'>"+gtp_name+"</div> <div class='goods_td goods_price_con_prop_value'>"+gp_name+"</div> </div>");
                }
                a.show();
                listWidth(a.children('.goods_price_con_list'));
            }
        });

        listWidth( $('#goods_price_default >.goods_price_con_list'));
    });
</script>